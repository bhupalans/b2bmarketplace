rules_version = '2';

// Helper functions to improve readability
function isOwner(userId) {
  return request.auth != null && request.auth.uid == userId;
}

function isSignedIn() {
  return request.auth != null;
}

function isAdmin() {
  return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isSeller() {
  return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'seller';
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Publicly readable, admin-writable
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Products can be read if approved.
    // Writes are restricted to the product owner (seller) or an admin.
    match /products/{productId} {
      allow read: if resource.data.status == 'approved';
      
      // A seller can create a product.
      allow create: if isSeller() && isOwner(request.resource.data.sellerId);

      // An owner can update their product, but cannot change the status.
      // An admin can update any product, including the status.
      allow update: if (isOwner(resource.data.sellerId) && request.resource.data.status == resource.data.status) || isAdmin();
      
      // An owner or an admin can delete a product.
      allow delete: if isOwner(resource.data.sellerId) || isAdmin();
    }

    // User documents can be read by anyone.
    // A user can only write to their own document. Admins can write to any.
    match /users/{userId} {
      allow read: if true;
      allow write: if isOwner(userId) || isAdmin();
    }

    // Internal documents are read/write for admins only.
    match /internal/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
