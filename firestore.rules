
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // Check for auth first to prevent errors on unauthed requests
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Admins have full access, which is useful for the approval workflow.
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isAuth(); // Allow creation during signup.
    }

    match /categories/{categoryId} {
      // Any authenticated user can read categories for the dropdown.
      allow get, list: if isAuth();
    }

    match /products/{productId} {
      // READ: Anyone can view an approved product.
      // A seller can view their own product regardless of status.
      allow get: if resource.data.status == 'approved' || (isAuth() && request.auth.uid == resource.data.sellerId);
      
      // LIST: Anyone can see the list of approved products.
      allow list: if query.filters.map(f => f[0]).hasOnly(['status']) && query.filters[0][2] == 'approved';

      // CREATE: An authenticated user can create a product if they are the owner and set the status to 'pending'.
      allow create: if isAuth() 
                    && request.resource.data.sellerId == request.auth.uid
                    && request.resource.data.status == 'pending';

      // UPDATE: A seller can update their own product IF they don't try to change the sellerId or status.
      // The status must be reset to 'pending' on update.
      allow update: if isAuth() 
                    && request.auth.uid == resource.data.sellerId
                    && request.resource.data.sellerId == resource.data.sellerId
                    && request.resource.data.status == 'pending';

      // DELETE: A seller can delete their own product.
      allow delete: if isAuth() && request.auth.uid == resource.data.sellerId;
    }
  }
}
