
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    match /categories/{categoryId} {
      allow read;
    }

    match /products/{productId} {
      // READ:
      // 1. Anyone can read an approved product.
      // 2. Admins can read any product.
      // 3. A seller can read their own product, regardless of status.
      allow read: if resource.data.status == 'approved'
        || (request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
        || (request.auth != null && request.auth.uid == resource.data.sellerId);
      
      // WRITE:
      // - CREATE: Allow a seller to create a product.
      // - UPDATE:
      //   1. Allow a seller to update their own product.
      //   2. Allow an admin to update the status of any product.
      // - DELETE: Allow a seller to delete their own product.
      allow write: if request.auth != null && (
        (request.resource.data.sellerId == request.auth.uid && request.method != 'update') ||
        (request.method == 'update' && (
          (request.resource.data.sellerId == request.auth.uid) ||
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']))
        )) ||
        (request.method == 'delete' && resource.data.sellerId == request.auth.uid)
      );
    }

    match /internal/{docId} {
      allow read, write: if false; // Internal collection, should not be client-accessible
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
